<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BDFD Utils — Endpoints</title>
  <meta name="description" content="Catálogo de endpoints do BDFD Utils — carregado dinamicamente de arquivos JSON." />
  <meta name="theme-color" content="#23072a" />

  <!-- =========================
       CSS (estilo Dark Code UI — consistente com a Home)
       ========================= -->
  <style>
    :root{
      --bg:#0b0710;
      --panel:#0f0814;
      --muted:#9aa0a6;
      --purple-700:#5b2aa5;
      --purple-500:#7d3fe0;
      --accent:#b88aff;
      --glass: rgba(255,255,255,0.03);
      --glass-strong: rgba(255,255,255,0.045);
      --card-shadow: 0 10px 30px rgba(11,7,16,0.65);
      --radius:12px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      --max-width:1100px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:
      radial-gradient(1200px 600px at 10% 10%, rgba(125,63,224,0.06), transparent 6%),
      radial-gradient(900px 400px at 90% 90%, rgba(91,42,165,0.04), transparent 6%),
      var(--bg);
      color:#eaeaf0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }

    /* layout */
    .wrap{max-width:var(--max-width);margin:28px auto;padding:20px;position:relative;z-index:10}
    header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:48px;height:48px;border-radius:10px;display:grid;place-items:center;
          background:linear-gradient(135deg,var(--purple-500),var(--purple-700));font-weight:700}
    .title{font-weight:700;font-size:18px}
    .subtitle{color:var(--muted);font-size:13px}

    nav a{color:var(--muted);text-decoration:none;margin-left:14px;font-size:14px}
    nav a:hover{color:#fff}

    main{margin-top:6px}
    h1{margin:0 0 12px;font-size:24px}
    p.lead{color:var(--muted);margin:0 0 18px}

    /* toolbar: search + filters */
    .toolbar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:18px}
    .search {
      flex:1 1 360px;
      display:flex;align-items:center;background:var(--panel);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);
      box-shadow:var(--card-shadow);
    }
    .search input{
      border:0;background:transparent;color:inherit;font-size:14px;padding:8px;outline:none;width:100%;
    }
    .filters{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .filter-btn{
      background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:10px;color:var(--muted);
      cursor:pointer;font-weight:600;font-size:13px;
    }
    .filter-btn.active{background:linear-gradient(90deg,var(--purple-700),var(--purple-500));color:white;box-shadow:0 8px 22px rgba(125,63,224,0.12)}
    .clear-filters{background:transparent;border:0;color:var(--muted);cursor:pointer;font-size:13px;text-decoration:underline}

    /* categories grid */
    .categories{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px}
    .category-card{
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.02);border-radius:var(--radius);padding:14px;box-shadow:var(--card-shadow);
      display:flex;flex-direction:column;gap:12px;min-height:80px;
    }
    .category-head{display:flex;justify-content:space-between;align-items:center}
    .category-title{font-weight:700}
    .category-count{color:var(--muted);font-size:13px}

    /* endpoint list inside each category */
    .endpoint-list{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .endpoint-item{
      display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;background:var(--glass-strong);border:1px solid rgba(255,255,255,0.02);
      cursor:pointer;transition:transform .12s ease,box-shadow .12s ease;
    }
    .endpoint-item:hover{transform:translateY(-4px);box-shadow:0 10px 28px rgba(125,63,224,0.06)}
    .method-badge{
      min-width:64px;padding:6px 8px;border-radius:8px;font-weight:700;font-size:13px;text-align:center;
      color:white;
    }
    .method-GET{background:linear-gradient(90deg,#2ea44f,#1f7a3a)}
    .method-POST{background:linear-gradient(90deg,#ff8a3d,#ff5e3a)}
    .method-PUT{background:linear-gradient(90deg,#3da0ff,#1b6fe8)}
    .method-DELETE{background:linear-gradient(90deg,#ff5c7c,#d93a5a)}
    .endpoint-meta{flex:1;min-width:0}
    .route{font-family:ui-monospace,monospace;font-size:13px;color:#e8e8ff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .desc{color:var(--muted);font-size:13px;margin-top:4px}

    /* modal (details) */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,2,6,0.6);display:none;align-items:center;justify-content:center;z-index:60;padding:20px}
    .modal{width:100%;max-width:820px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:14px;padding:18px;border:1px solid rgba(255,255,255,0.02);box-shadow:0 20px 60px rgba(11,7,16,0.7);color:inherit}
    .modal .row{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap}
    .modal h2{margin:0 0 8px}
    .meta {font-size:13px;color:var(--muted);margin-bottom:12px}
    .json-pre{background:#07060a;padding:12px;border-radius:8px;font-family:ui-monospace,monospace;font-size:13px;color:#dbe7ff;overflow:auto;max-height:260px}
    .modal-close{background:transparent;border:0;color:var(--muted);cursor:pointer;font-weight:700}
    .modal-actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .badge{display:inline-block;padding:6px 10px;border-radius:10px;background:rgba(255,255,255,0.02);font-weight:700;color:var(--muted);font-size:13px}

    /* empty state */
    .empty{padding:20px;border-radius:10px;background:var(--glass);color:var(--muted);text-align:center}

    /* responsive */
    @media (max-width:880px){
      .toolbar{flex-direction:column;align-items:stretch}
      .search{flex:1 1 auto}
    }
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <header>
      <div class="brand" aria-hidden="false">
        <div class="logo" aria-hidden="true">BDFD</div>
        <div>
          <div class="title">BDFD Utils — Endpoints</div>
          <div class="subtitle">Catálogo carregado dinamicamente (pasta /endpoints/)</div>
        </div>
      </div>

      <nav aria-label="principal">
        <a href="index.html">Home</a>
        <a href="docs.html">Docs</a>
        <a href="endpoints.html" aria-current="page">Endpoints</a>
        <a href="contact.html">Contato</a>
      </nav>
    </header>

    <main>
      <h1>Endpoints disponíveis</h1>
      <p class="lead">Pesquise, filtre por método e abra um detalhe completo do endpoint.</p>

      <!-- toolbar -->
      <div class="toolbar" role="region" aria-label="ferramentas de pesquisa e filtros">
        <div class="search" role="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-right:8px;opacity:.9">
            <path d="M21 21l-4.35-4.35" stroke="rgba(255,255,255,0.9)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="11" cy="11" r="6" stroke="rgba(255,255,255,0.9)" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <input id="search" type="search" placeholder="Pesquisar rota, descrição, categoria..." aria-label="Pesquisar endpoints">
          <button id="clear-search" title="Limpar pesquisa" style="border:0;background:transparent;color:var(--muted);cursor:pointer;font-weight:700;display:none">✕</button>
        </div>

        <div class="filters" role="toolbar" aria-label="filtros por método">
          <button class="filter-btn" data-method="ALL">Todos</button>
          <button class="filter-btn" data-method="GET">GET</button>
          <button class="filter-btn" data-method="POST">POST</button>
          <button class="filter-btn" data-method="PUT">PUT</button>
          <button class="filter-btn" data-method="DELETE">DELETE</button>
          <button id="clear" class="clear-filters" type="button">Limpar filtros</button>
        </div>
      </div>

      <!-- categories grid -->
      <div id="categories" class="categories" aria-live="polite"></div>

      <div id="empty" class="empty" style="display:none">Nenhum endpoint encontrado.</div>
    </main>

    <footer style="margin-top:18px;color:var(--muted);font-size:13px">© <span id="year"></span> BDFD Utils — Catálogo de endpoints.</footer>
  </div>

  <!-- modal -->
  <div id="modal-backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modal-title">
      <div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start">
        <div>
          <h2 id="modal-title"></h2>
          <div id="modal-meta" class="meta"></div>
        </div>
        <div>
          <button id="modal-close" class="modal-close" aria-label="Fechar">✕</button>
        </div>
      </div>

      <div id="modal-desc" class="desc" style="margin-bottom:12px"></div>

      <div id="modal-auth" style="margin-bottom:12px"></div>

      <div id="modal-examples" style="display:flex;gap:12px;flex-wrap:wrap"></div>

      <div style="margin-top:10px">
        <div style="font-weight:700;margin-bottom:6px">Exemplo de resposta</div>
        <pre id="modal-response" class="json-pre" aria-live="polite"></pre>
      </div>

      <div style="margin-top:12px;display:flex;justify-content:flex-end">
        <button class="filter-btn" id="copy-route">Copiar Rota</button>
        <button class="filter-btn" id="copy-curl" style="background:linear-gradient(90deg,var(--purple-700),var(--purple-500));color:#fff">Copiar cURL</button>
      </div>
    </div>
  </div>

  <!-- =========================
       JavaScript: carregamento dinâmico, search, filtro, modal
       ========================= -->
  <script>
    // Configuração: pasta onde os JSONs de categoria residirão.
    // Estrutura recomendada:
    // /endpoints/manifest.json -> { "files": ["geral.json","ferramentas.json","usuarios.json"] }
    // /endpoints/geral.json -> { "category":"Geral","items":[ {route,method,description,auth,params,examples,response} ] }
    const ENDPOINTS_DIR = '/endpoints'; // ajuste conforme deploy
    const MANIFEST_URL = ENDPOINTS_DIR + '/manifest.json';

    // Elementos
    const categoriesEl = document.getElementById('categories');
    const searchInput = document.getElementById('search');
    const clearSearchBtn = document.getElementById('clear-search');
    const filterBtns = Array.from(document.querySelectorAll('.filter-btn'));
    const clearFiltersBtn = document.getElementById('clear');
    const emptyEl = document.getElementById('empty');

    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalTitle = document.getElementById('modal-title');
    const modalMeta = document.getElementById('modal-meta');
    const modalDesc = document.getElementById('modal-desc');
    const modalAuth = document.getElementById('modal-auth');
    const modalResponse = document.getElementById('modal-response');
    const modalExamples = document.getElementById('modal-examples');
    const modalCloseBtn = document.getElementById('modal-close');
    const copyRouteBtn = document.getElementById('copy-route');
    const copyCurlBtn = document.getElementById('copy-curl');

    let dataset = {};       // objeto { categoryName: [items...] }
    let flatList = [];      // array de itens com {category,...}
    let activeMethod = 'ALL';
    let lastQuery = '';

    // inicializa
    document.getElementById('year').textContent = new Date().getFullYear();

    // util: safe JSON fetch with fallback
    async function fetchJson(url){
      const res = await fetch(url, {cache: 'no-cache'});
      if (!res.ok) throw new Error('Falha ao buscar ' + url + ' ('+res.status+')');
      return await res.json();
    }

    // carrega manifest e arquivos de categoria
    async function loadAllEndpoints(){
      try{
        const manifest = await fetchJson(MANIFEST_URL);
        if (!manifest || !Array.isArray(manifest.files)) throw new Error('Manifest inválido');
        const files = manifest.files;

        const promises = files.map(f => fetchJson(ENDPOINTS_DIR + '/' + f).catch(err => {
          console.error('Erro carregando', f, err);
          return null;
        }));

        const raws = await Promise.all(promises);

        dataset = {};
        flatList = [];

        raws.forEach(raw => {
          if (!raw) return;
          const category = raw.category || 'Sem categoria';
          const items = Array.isArray(raw.items) ? raw.items : (raw.endpoints || []);
          dataset[category] = items.map(it => {
            // normalizar campos mínimos
            const norm = {
              category,
              route: it.route || it.path || '',
              method: (it.method || 'GET').toUpperCase(),
              description: it.description || '',
              auth: !!it.auth,
              params: it.params || null,
              examples: it.examples || null,
              response: it.response || null,
              raw: it
            };
            flatList.push(norm);
            return norm;
          });
        });

        renderCategories();
      }catch(err){
        console.error(err);
        categoriesEl.innerHTML = '<div class="empty">Erro ao carregar endpoints. Verifique /endpoints/manifest.json</div>';
      }
    }

    // Construção das cards por categoria
    function renderCategories(){
      categoriesEl.innerHTML = '';
      const categories = Object.keys(dataset);
      if (!categories.length) {
        emptyEl.style.display = 'block';
        return;
      }
      emptyEl.style.display = 'none';

      categories.forEach(cat => {
        const items = dataset[cat] || [];
        const card = document.createElement('div');
        card.className = 'category-card';
        card.innerHTML = `
          <div class="category-head">
            <div>
              <div class="category-title">${escapeHtml(cat)}</div>
              <div class="category-count">${items.length} endpoint(s)</div>
            </div>
            <div class="badge">${items.length}</div>
          </div>
        `;

        const list = document.createElement('div');
        list.className = 'endpoint-list';

        items.forEach(item => {
          const itemEl = document.createElement('button');
          itemEl.type = 'button';
          itemEl.className = 'endpoint-item';
          itemEl.setAttribute('data-route', item.route);
          itemEl.setAttribute('data-method', item.method);

          // method badge + route + desc
          itemEl.innerHTML = `
            <div class="method-badge method-${escapeHtml(item.method)}">${escapeHtml(item.method)}</div>
            <div class="endpoint-meta">
              <div class="route">${escapeHtml(item.route)}</div>
              <div class="desc">${escapeHtml(item.description || '')}</div>
            </div>
          `;
          itemEl.addEventListener('click', () => openDetail(item));
          list.appendChild(itemEl);
        });

        card.appendChild(list);
        categoriesEl.appendChild(card);
      });

      applyFiltersAndSearch(); // aplica filtros após render
    }

    // escape para segurança
    function escapeHtml(s=''){
      return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    }

    // busca / filtros
    function applyFiltersAndSearch(){
      const q = lastQuery.trim().toLowerCase();
      const method = activeMethod;
      const itemsEls = Array.from(document.querySelectorAll('.endpoint-item'));
      let visibleCount = 0;

      itemsEls.forEach(el => {
        const route = el.getAttribute('data-route') || '';
        const m = el.getAttribute('data-method') || '';
        const desc = (el.querySelector('.desc')?.textContent) || '';
        const cat = el.closest('.category-card')?.querySelector('.category-title')?.textContent || '';

        const matchesQuery = !q || (route.toLowerCase().includes(q) || desc.toLowerCase().includes(q) || cat.toLowerCase().includes(q));
        const matchesMethod = (method === 'ALL') || (m === method);

        if (matchesQuery && matchesMethod) {
          el.style.display = '';
          visibleCount++;
        } else {
          el.style.display = 'none';
        }
      });

      // show empty state if nothing visible across all categories
      emptyEl.style.display = visibleCount ? 'none' : 'block';
    }

    // search handlers (debounced)
    let searchTimer = null;
    searchInput.addEventListener('input', (e) => {
      const v = e.target.value;
      lastQuery = v;
      clearTimeout(searchTimer);
      searchTimer = setTimeout(() => {
        applyFiltersAndSearch();
        clearSearchBtn.style.display = v ? 'inline' : 'none';
      }, 180);
    });
    clearSearchBtn.addEventListener('click', () => {
      searchInput.value = '';
      lastQuery = '';
      clearSearchBtn.style.display = 'none';
      applyFiltersAndSearch();
      searchInput.focus();
    });

    // filtros de método
    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const method = btn.getAttribute('data-method');
        if (!method) return;
        activeMethod = method;
        filterBtns.forEach(b => b.classList.toggle('active', b === btn));
        applyFiltersAndSearch();
      });
    });
    // default active = ALL
    document.querySelector('.filter-btn[data-method="ALL"]').classList.add('active');

    clearFiltersBtn.addEventListener('click', () => {
      activeMethod = 'ALL';
      lastQuery = '';
      searchInput.value = '';
      clearSearchBtn.style.display = 'none';
      filterBtns.forEach(b => b.classList.toggle('active', b.getAttribute('data-method') === 'ALL'));
      applyFiltersAndSearch();
    });

    // abrir modal com detalhes (mostra apenas campos existentes)
    function openDetail(item){
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden', 'false');
      modalTitle.textContent = (item.route || '—');
      modalMeta.innerHTML = `
        <span class="badge">${escapeHtml(item.method)}</span>
        ${item.auth ? '<span class="badge">Auth</span>' : ''}
        <span style="margin-left:8px;color:var(--muted);font-size:13px">Categoria: ${escapeHtml(item.category)}</span>
      `;
      modalDesc.textContent = item.description || '';
      modalAuth.innerHTML = item.auth ? `<div style="color:var(--muted);font-size:13px">Requer autenticação</div>` : '';

      // examples: render code examples (if exist)
      modalExamples.innerHTML = '';
      if (item.examples && Array.isArray(item.examples) && item.examples.length) {
        item.examples.forEach(ex => {
          const exEl = document.createElement('div');
          exEl.className = 'json-pre';
          exEl.style.minWidth = '220px';
          exEl.textContent = typeof ex === 'string' ? ex : JSON.stringify(ex, null, 2);
          modalExamples.appendChild(exEl);
        });
      } else {
        // mostrar um snippet padrão (fetch)
        const snippet = `// fetch example\nfetch('${item.route}')\n  .then(r => r.json())\n  .then(console.log)`;
        const exEl = document.createElement('div');
        exEl.className = 'json-pre';
        exEl.textContent = snippet;
        modalExamples.appendChild(exEl);
      }

      // response
      modalResponse.textContent = item.response ? JSON.stringify(item.response, null, 2) : '{ }';

      // actions
      copyRouteBtn.onclick = () => {
        navigator.clipboard?.writeText(item.route || '').then(() => {
          copyRouteBtn.textContent = 'Copiado!';
          setTimeout(()=> copyRouteBtn.textContent = 'Copiar Rota', 1200);
        });
      };
      copyCurlBtn.onclick = () => {
        const curl = `curl -s ${location.origin}${item.route}`;
        navigator.clipboard?.writeText(curl).then(()=> {
          copyCurlBtn.textContent = 'Copiado!';
          setTimeout(()=> copyCurlBtn.textContent = 'Copiar cURL', 1200);
        });
      };

      // focus trap minimal
      modalCloseBtn.focus();
    }

    // fechar modal
    function closeModal(){
      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden', 'true');
    }
    modalCloseBtn.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) closeModal();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modalBackdrop.style.display === 'flex') closeModal();
    });

    // inicialização
    loadAllEndpoints();

    // Observabilidade mínima: expõe uma função para recarregar (útil para deploy)
    window.bdfd_reload_endpoints = loadAllEndpoints;

    // Nota: para o funcionamento, crie os arquivos:
    // /endpoints/manifest.json  -> { "files": ["geral.json","ferramentas.json","usuarios.json"] }
    // /endpoints/geral.json     -> { "category":"Geral", "items":[ { "route":"/v1/status","method":"GET", "description":"...", "auth":false, "response": {...}, "examples":[ ... ] } ] }
    // Cada arquivo pode ter nome livre, contanto que esteja listado no manifest.
  </script>
</body>
</html>
